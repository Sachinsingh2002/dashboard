var svg,nodes,links,force,drag_line,path,circle,selected_node,selected_link,mousedown_link,mousedown_node,mouseup_node,button,width=500,height=500,colors=function(){return"#FFF"};function start(t,e){width=document.getElementsByClassName("serviceCard")[0].offsetWidth;let n=500*t.length*-1;d3.select("svg").empty()||(svg=d3.select(".graph").select("svg")).remove(),svg=d3.select(".graph").append("svg").attr("width","100%").attr("height",height),nodes=t,links=e,force=d3.layout.force().nodes(nodes).links(links).size([width,height]).linkDistance(200).charge(n).on("tick",tick),svg.append("svg:defs").append("svg:marker").attr("id","end-arrow").attr("viewBox","0 -5 10 10").attr("refX",6).attr("markerWidth",3).attr("markerHeight",3).attr("orient","auto").attr("markerUnits","strokeWidth").attr("stroke-width","13").append("svg:path").attr("d","M0,-5L10,0L0,5").attr("fill","#000"),svg.append("svg:defs").append("svg:marker").attr("id","start-arrow").attr("viewBox","0 -5 10 10").attr("refX",4).attr("markerWidth",3).attr("markerHeight",3).attr("orient","auto").attr("markerUnits","strokeWidth").attr("stroke-width","13").append("svg:path").attr("d","M10,-5L0,0L10,5").attr("fill","#000"),drag_line=svg.append("svg:path").attr("class","link dragline hidden").attr("d","M0,0L0,0"),path=svg.append("svg:g").selectAll("path"),circle=svg.append("svg:g").selectAll("g"),button=svg.append("svg:g").selectAll("g"),selected_node=null,selected_link=null,mousedown_link=null,mousedown_node=null,mouseup_node=null,main()}function resetMouseVars(){mousedown_node=null,mouseup_node=null,mousedown_link=null}function restart(){(path=path.data(links)).classed("selected",function(e){return e===selected_link}).style("marker-start",function(e){return e.left?"url(#start-arrow)":""}).style("marker-end",function(e){return e.right?"url(#end-arrow)":""}),path.enter().append("svg:path").attr("class","link").classed("selected",function(e){return e===selected_link}).style("marker-start",function(e){return e.left?"url(#start-arrow)":""}).style("marker-end",function(e){return e.right?"url(#end-arrow)":""}).on("mousedown",function(e){d3.event.ctrlKey||(selected_node=null,setTextInView(selected_link=(mousedown_link=e)===selected_link?null:mousedown_link),restart())}),path.exit().remove(),button=button.data(nodes,function(e){return e.id}),(circle=circle.data(nodes,function(e){return e.id})).selectAll("circle").style("fill",function(e){return e===selected_node?d3.rgb(colors(e.id)).darker().toString():colors(e.id)}).classed("reflexive",function(e){return e.reflexive});var t=circle.enter().append("svg:g");t.append("svg:circle").attr("class","node").attr("r",40).style("fill",function(e){return e===selected_node?d3.rgb(colors(e.id)).brighter().toString():colors(e.id)}).style("stroke",function(e){return d3.rgb(colors(e.id)).darker().toString()}).classed("reflexive",function(e){return e.reflexive}).on("mouseover",function(e){d3.select(this).attr("transform","scale(1.1)"),mousedown_node&&e!==mousedown_node&&d3.select(this).attr("transform","scale(1.1)")}).on("mouseout",function(e){e===selected_node||e===mousedown_node||d3.select(this).attr("transform","scale(0.99)")}).on("mousedown",function(e){d3.event.ctrlKey||(selected_link=null,null!=(selected_node=(mousedown_node=e)===selected_node?null:mousedown_node)&&sendToModelNode(selected_node),drag_line.style("marker-end","url(#end-arrow)").classed("hidden",!1).attr("d","M"+mousedown_node.x+","+mousedown_node.y+"L"+mousedown_node.x+","+mousedown_node.y),restart())}).on("mouseup",function(e){if(mousedown_node){if(drag_line.classed("hidden",!0).style("marker-end",""),(mouseup_node=e)===mousedown_node)return void resetMouseVars();link={source:mousedown_node,target:mouseup_node,left:!1,right:!0},links.push(link),addLinkToDB(link),selected_link=link,selected_node=null,restart()}}),t.append("svg:text").attr("x",0).attr("y",4).attr("class","id").text(function(e){return shortenName(e.id)}),circle.exit().remove(),force.start()}function shortenName(t){return t.length>10?t.substring(0,Math.min(t.length,10))+"...":t}function tick(){path.attr("d",function(t){var e=t.target.x-t.source.x,r=t.target.y-t.source.y,n=Math.sqrt(e*e+r*r),s=e/n,l=r/n,u=t.left?45:12,d=t.right?45:12;return"M"+(t.source.x+u*s)+","+(t.source.y+u*l)+"L"+(t.target.x-d*s)+","+(t.target.y-d*l)}),circle.attr("transform",function(t){return"translate("+t.x+","+t.y+")"})}function mousedown(){svg.classed("active",!0),!(d3.event.ctrlKey||mousedown_node||mousedown_link)&&restart()}function mousemove(){!mousedown_node||(drag_line.attr("d","M"+mousedown_node.x+","+mousedown_node.y+"L"+d3.mouse(this)[0]+","+d3.mouse(this)[1]),restart())}function mouseup(){mousedown_node&&drag_line.classed("hidden",!0).style("marker-end",""),svg.classed("active",!1),resetMouseVars()}function spliceLinksForNode(t){links.filter(function(r){return r.source===t||r.target===t}).map(function(r){links.splice(links.indexOf(r),1)})}var lastKeyDown=-1;function keydown(){-1===lastKeyDown&&(lastKeyDown=d3.event.keyCode,17===d3.event.keyCode&&(circle.call(force.drag),svg.classed("ctrl",!0)))}function deleteLink(){selected_node?(nodes.splice(nodes.indexOf(selected_node),1),spliceLinksForNode(selected_node)):selected_link&&links.splice(links.indexOf(selected_link),1),selected_link=null,selected_node=null,restart()}function keyup(){lastKeyDown=-1,17===d3.event.keyCode&&(circle.on("mousedown.drag",null).on("touchstart.drag",null),svg.classed("ctrl",!1))}function sendToModelNode(t){document.getElementById("testText").innerText=t.id,document.getElementById("IdText").innerText=t.idNumber,document.getElementById("typeText").innerText="Node:"}function setTextInView(t){document.getElementById("typeText").innerText="Link:",document.getElementById("IdLinkStart").innerText=t.source.idNumber,document.getElementById("IdLinkTarget").innerText=t.target.idNumber,document.getElementById("testText").innerText='Link between "'+t.source.id+'" and "'+t.target.id+'"'}function addLinkToDB(t){setTextInView(t),document.getElementById("configureLink").click()}function main(){this.svg.on("mousedown",this.mousedown).on("mousemove",mousemove).on("mouseup",mouseup),d3.select(window).on("keydown",keydown).on("keyup",keyup),this.restart()}function initMap(t,e,r){const n=ol.proj.fromLonLat([t,e]),s=new ol.Feature({geometry:new ol.geom.Point(ol.proj.fromLonLat([t,e]))});s.setStyle(new ol.style.Style({image:new ol.style.Icon({imgSize:[50,80],src:"assets/js/marker_map.svg"})}));const l=new ol.Feature({geometry:new ol.geom.Circle(n,r)});l.setStyle(new ol.style.Style({renderer(f,g){const[[o,i],[h,k]]=f,a=g.context,p=h-o,y=k-i,m=Math.sqrt(p*p+y*y),c=a.createRadialGradient(o,i,0,o,i,1.4*m);c.addColorStop(0,"rgba(255,0,0,0)"),c.addColorStop(.6,"rgba(0,0,255,0.2)"),c.addColorStop(1,"rgba(0,0,255,0.8)"),a.beginPath(),a.arc(o,i,m,0,2*Math.PI,!0),a.fillStyle=c,a.fill(),a.arc(o,i,m,0,2*Math.PI,!0),a.strokeStyle="rgba(0,0,255,1)",a.stroke()}}));const u=new ol.source.Vector({features:[s,l]}),d=new ol.layer.Vector({source:u});new ol.Map({target:"map",layers:[new ol.layer.Tile({source:new ol.source.OSM}),d],view:new ol.View({center:n,zoom:15})})}